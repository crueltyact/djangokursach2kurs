{% include 'base/header.html' %}
{% load static %}
<body>
{% include 'base/body.html' %}
{% block body %}
<div class="main">
    <div class="container h-100">
        <div class="row d-flex h-100">
            {% include 'base/menu.html' %}
            <fieldset class="col-9 pt-5">
                <form method="post" action="/result/">
                    {% csrf_token %}
                    <div id="smartwizard">
                        <ul class="nav">
                            <li class="nav-item">
                                <a class="nav-link" href="#step-1">
                                    <div class="num">1</div>
                                    <!--                                    Цели и задачи-->
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#step-2">
                                    <span class="num">2</span>
                                    <!--                                    Разделы-->
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#step-3">
                                    <span class="num">3</span>
                                    <!--                                    Связанные дисциплины-->
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link " href="#step-4">
                                    <span class="num">4</span>
                                    <!--                                    Дидактическое содержание-->
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link " href="#step-5">
                                    <span class="num">5</span>
                                    <!--                                    Оценка результатов-->
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link " href="#step-6">
                                    <span class="num">6</span>
                                    <!--                                    Литература-->
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link " href="#step-7">
                                    <span class="num">7</span>
                                    <!--                                    Требования к ПО-->
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link " href="#step-8">
                                    <span class="num">8</span>
                                    <!--                                    Перечень оценочных средств-->
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link " href="#step-9">
                                    <span class="num">9</span>
                                    <!--                                    Задания-->
                                </a>
                            </li>
                        </ul>

                        <div class="tab-content">
                            <div id="step-1" class="tab-pane" role="tabpanel" aria-labelledby="step-1">
                                <fieldset class="col-12 pt-5">
                                    <legend class="col-form-label col-md-12 pt-0"><p class="h2">Цели и задачи</p>
                                    </legend>
                                    <div class="mb-3">
                                        <label for="targets" class="form-label">Цели изучения</label>
                                        <textarea class="form-control" name="targets" id="targets"
                                                  placeholder="Добавьте цели изучения"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="tasks" class="form-label">Задачи</label>
                                        <textarea class="form-control" name="tasks" id="tasks"
                                                  placeholder="Добавьте задачи"></textarea>
                                    </div>
                                </fieldset>
                            </div>
                            <div id="step-2" class="tab-pane" role="tabpanel" aria-labelledby="step-2">
                                <fieldset id="sections" class="col-12 pt-5">
                                    <legend class="col-form-label col-md-12 pt-0"><p class="h2">Выпишите изучаемые
                                        разделы</p>
                                    </legend>
                                    <div class="mb-3">
                                        <div class="input-group">
                                            <input type="text" value="Раздел" aria-label="First name"
                                                   class="form-control"
                                                   readonly>
                                            <input type="Text" value="Часов" aria-label="Last name" class="form-control"
                                                   readonly>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <div class="input-group sections">
                                            <input type="text" name="section" aria-label="First name"
                                                   class="form-control section">
                                            <input type="text" name="hours" aria-label="Last name" class="form-control hour">
                                        </div>
                                    </div>
                                    <button id="addInputGroup" type="button" class="btn btn-primary"
                                            onclick="addInputs()">Добавить раздел
                                    </button>
                                </fieldset>
                            </div>
                            <div id="step-3" class="tab-pane" role="tabpanel" aria-labelledby="step-3">
                                <fieldset class="col-12 pt-5">
                                    <legend class="col-form-label col-md-12 pt-0"><p class="h2">Выберите дисциплины, с
                                        которыми связана {{theme}}</p>
                                    </legend>
                                    <div class="row">
                                        <div class="col-sm-6">
                                            <div id="modules">
                                                {% for cur_theme in all_themes %}
                                                    {% if cur_theme.program_name != theme %}
                                                        <p class="drag"><a class="btn btn-default text-start">{{ cur_theme.program_name }}</a></p>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div class="col-sm-6">
                                            <div id="dropzone"></div>
                                        </div>
                                    </div>
                                </fieldset>
                            </div>
                            <div id="step-4" class="tab-pane" role="tabpanel" aria-labelledby="step-4">
                                <fieldset class="col-12 pt-5">
                                    <legend class="col-form-label col-md-12 pt-0"><p class="h2">Дидактическое содержание
                                        разделов</p>
                                    </legend>
                                    <div class="input-group mb-3">
                                        <label class="input-group-text" for="theme">Тема</label>
                                        <select class="form-select" id="theme" name="theme">
                                            <option selected value="choose_theme" id="choose_theme">Выберите тему
                                            </option>
                                        </select>
                                    </div>
                                    <div id="section">

                                    </div>
                                </fieldset>
                            </div>
                            <div id="step-5" class="tab-pane" role="tabpanel" aria-labelledby="step-5">
                                <fieldset class="row mb-3">
                                    <legend class="col-form-label col-sm-2 pt-0">Оценка результатов</legend>
                                    <div class="row mb-3">
                                        <div class="col-sm-5">
                                            <label for="competentions" class="col-sm-2 col-form-label">По
                                                компетенциям</label>
                                        </div>
                                        <div class="col-sm-5  ms-3">
                                            <input type="checkbox" name="competentions" value="1"
                                                   class="form-check-input"
                                                   id="competentions">
                                            <input type="checkbox" name="competentions" value="0"
                                                   class="form-check-input"
                                                   id="competentions1">
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-sm-5">
                                            <label for="attestation" class="col-sm-2 col-form-label">По промежуточной
                                                аттестации</label>
                                        </div>
                                        <div class="col-sm-5  ms-3">
                                            <input type="checkbox" name="attestation" value="1" class="form-check-input"
                                                   id="attestation">
                                            <input type="checkbox" name="attestation" value="0" class="form-check-input"
                                                   id="attestation1">
                                        </div>
                                    </div>
                                    <div class="row mb-3 ml-3">
                                        <div class="col-sm-5">
                                            <label for="score_system" class="col-sm-2 col-form-label">Есть бальная
                                                система</label>
                                        </div>
                                        <div class="col-sm-5 ms-3">
                                            <input type="checkbox" name="score_system" value="1"
                                                   class="form-check-input"
                                                   id="score_system">
                                            <input type="checkbox" name="score_system" value="0"
                                                   class="form-check-input"
                                                   id="score_system1">
                                        </div>
                                    </div>
                                </fieldset>
                                <div class="row mb-3 ml-3" id="marks">
<!--                                    <div class="col-md-6">-->
<!--                                        <div class="col-md-5">-->
<!--                                            <label for="competention" class="form-label">Компетенция</label>-->
<!--                                        </div>-->
<!--                                        <div class="col-sm-5">-->
<!--                                            <input type="text" name="competention" class="form-control"-->
<!--                                                   id="competention">-->
<!--                                        </div>-->
<!--                                    </div>-->
                                    <div class="mb-3">
                                        <div class="input-group">
                                            <input type="text" value="Оценка" aria-label="First name"
                                                   class="form-control"
                                                   readonly>
                                            <input type="Text" value="Описание" aria-label="Last name" class="form-control"
                                                   readonly>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <div class="input-group marks">
                                            <input type="number" name="mark" aria-label="First name"
                                                   class="form-control mark">
                                            <input type="text" name="description" aria-label="Last name" class="form-control description">
                                        </div>
                                    </div>
                                    <button id="addInputGroupMarks" type="button" class="btn btn-primary"
                                            onclick="addInputsMarks()">Добавить оценку
                                    </button>
                                </div>
                                <div id="brs" class="mb-3 d-none">
                                    <label for="score_system_desc" class="form-label">Описание БРС</label>
                                    <textarea class="form-control" name="score_system_desc"
                                              id="score_system_desc"
                                              placeholder="Описание БРС"></textarea>
                                </div>
                            </div>
                            <div id="step-6" class="tab-pane" role="tabpanel" aria-labelledby="step-6">
                                <fieldset class="col-12 pt-5">
                                    <legend class="col-form-label col-md-12 pt-0"><p class="h2">Добавление
                                        источников</p>
                                    </legend>
                                    <div class="mb-3">
                                        <label for="main_lit" class="form-label">Основные</label>
                                        <textarea class="form-control" name="main_lit" id="main_lit"
                                                  placeholder="Основные источники литературы"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="extra_lit" class="form-label">Дополнительные</label>
                                        <textarea class="form-control" name="extra_lit" id="extra_lit"
                                                  placeholder="Дополнительные источники литературы"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="digital_lit" class="form-label">Электронные</label>
                                        <textarea class="form-control" name="digital_lit" id="digital_lit"
                                                  placeholder="Цифровые источники литературы"></textarea>
                                    </div>
                                </fieldset>
                            </div>
                            <div id="step-7" class="tab-pane" role="tabpanel" aria-labelledby="step-7">
                                <div class="mb-3">
                                    <label for="software" class="form-label"><p class="h2">Требования к ПО</p></label>
                                    <textarea class="form-control" name="software" id="software"
                                              placeholder="Требования к ПО"></textarea>
                                </div>
                            </div>
                            <div id="step-8" class="tab-pane" role="tabpanel" aria-labelledby="step-8">
                                <div class="mb-3">
                                    <label for="evaluation_tools" class="form-label"><p class="h2">Перечень оценочных
                                        средств</p></label>
                                    <textarea class="form-control" name="evaluation_tools" id="evaluation_tools"
                                              placeholder="Переченб оценочных средств"></textarea>
                                </div>
                            </div>
                            <div id="step-9" class="tab-pane" role="tabpanel" aria-labelledby="step-9">
                                <div class="mb-3">
                                    <label for="tasks_from_file" class="form-label"><p class="h2">Задания</p></label>
                                    <textarea class="form-control" name="tasks_from_file" id="tasks_from_file"
                                              placeholder="Задания"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: 0" aria-valuenow="0"
                                 aria-valuemin="0"
                                 aria-valuemax="100"></div>
                        </div>
                    </div>
                    <input type="hidden" name="document" value="{{ document }}">
                </form>
            </fieldset>
        </div>
    </div>
</div>
{% endblock %}
<!-- <footer class="footer">
    <p>&copy Лучшая команда КИС 2022</p>
</footer> -->
{% include 'base/scripts.html' %}
<script>
    $(function () {
        $('#smartwizard').smartWizard({
            selected: 0,
            theme: 'round',
            justified: true,
            autoAdjustHeight: true,
            backButtonSupport: true,
            enableUrlHash: true,
            transition: {
                animation: 'fade',
                speed: '400',
            },
            toolbar: {
                position: 'bottom',
                showNextButton: true,
                showPreviousButton: true,
                extraHtml: '<button class="btn btn-success" name="end" value="generate" onclick="generate_output()" type="submit">Закончить</button>' // Extra html to show on toolbar
            },
            anchor: {
                enableNavigation: true,
                enableNavigationAlways: true, // Activates all anchors clickable always
                enableDoneState: true,
                markPreviousStepsAsDone: true,
                unDoneOnBackNavigation: false,
                enableDoneStateNavigation: true
            },
            keyboard: {
                keyNavigation: true,
                keyLeft: [37],
                keyRight: [39]
            },
            lang: {
                next: 'Далее',
                previous: 'Назад'
            },
            disabledSteps: [], // Array Steps disabled
            errorSteps: [], // Array Steps error
            warningSteps: [], // Array Steps warning
            hiddenSteps: [], // Hidden steps
            getContent: null // Callback function for content loading
        });
        $('.drag').draggable({
            appendTo: 'body',
            helper: 'clone'
        });

        $('#dropzone').droppable({
            activeClass: 'active',
            hoverClass: 'hover',
            accept: ":not(.ui-sortable-helper)", // Reject clones generated by sortable
            drop: function (e, ui) {
                var $el = $(ui.draggable);
                // $el.click(function () {
                //     $('#dropzone').append(ui.draggable);
                //     ui.draggable.remove();
                // });
                $(this).append($el);
                $('#smartwizard').smartWizard("fixHeight");
            }
        }).sortable({
            items: '.drop-item',
            sort: function () {
                // gets added unintentionally by droppable interacting with sortable
                // using connectWithSortable fixes this, but doesn't allow you to customize active/hoverClass options
                // $(this).removeClass("active");
            }
        });
        $('#modules').droppable({
            activeClass: 'active',
            hoverClass: 'hover',
            accept: ":not(.ui-sortable-helper)", // Reject clones generated by sortable
            drop: function (e, ui) {
                var $el = $(ui.draggable);
                // $el.click(function () {
                //     $('#dropzone').append(ui.draggable);
                //     ui.draggable.remove();
                // });
                $(this).append($el);
                $('#smartwizard').smartWizard("fixHeight");
            }
        }).sortable({
            items: '.drop-item',
            sort: function () {
                // gets added unintentionally by droppable interacting with sortable
                // using connectWithSortable fixes this, but doesn't allow you to customize active/hoverClass options
                // $(this).removeClass("active");
            }
        });
    });
    let added_sections = [];
    $("#smartwizard").on("showStep", function (e, anchorObject, stepIndex, stepDirection, stepPosition) {
        if (stepIndex === 3) {
            let section = document.getElementsByClassName("sections");
            let output_div = document.getElementById("section");
            let dict = {};
            for (let i = 0; i < section.length; i++) {
                dict[section[i].children[0].value] = section[i].children[1].value;
            }
            let sections = document.getElementById("theme");
            for (let [key, value] of Object.entries(dict)) {
                if (key && added_sections.indexOf(key) === -1) {
                    added_sections.push(key);
                    //Create option in select
                    let section_content = document.createElement("option");
                    section_content.textContent = key;
                    section_content.setAttribute("value", iuliia.translate(key, iuliia.WIKIPEDIA));
                    sections.appendChild(section_content);
                    //Create div for all themes
                    let theme = document.createElement("div");
                    theme.setAttribute("id", iuliia.translate(key, iuliia.WIKIPEDIA))
                    theme.setAttribute("class", "d-none");
                    //Create hours input field
                    let hour = document.createElement("div");
                    hour.setAttribute("class", "row mb-3 " + iuliia.translate(key, iuliia.WIKIPEDIA));
                    let hour_label = document.createElement("label");
                    hour_label.textContent = "Часы";
                    hour_label.setAttribute("for", "hour");
                    hour_label.setAttribute("class", "col-sm-2 col-form-label");
                    hour.appendChild(hour_label);
                    let hour_input_div = document.createElement("div");
                    hour_input_div.setAttribute("class", "col-sm-10");
                    let hour_input = document.createElement("input");
                    hour_input.setAttribute("value", value.toString());
                    hour_input.setAttribute("class", "form-control");
                    hour_input.setAttribute("type", "number");
                    hour_input.setAttribute("readonly","");
                    hour_input.setAttribute("id", "hour");
                    hour_input_div.appendChild(hour_input);
                    hour.appendChild(hour_input_div);
                    theme.appendChild(hour);
                    //Create content input field
                    let content = document.createElement("div");
                    content.setAttribute("class", "mb-3 " + iuliia.translate(key, iuliia.WIKIPEDIA));
                    let content_label = document.createElement("label");
                    content_label.textContent = "Содержание";
                    content_label.setAttribute("for", "content");
                    content_label.setAttribute("class", "form-label");
                    content.appendChild(content_label);
                    let content_textarea = document.createElement("textarea");
                    content_textarea.setAttribute("placeholder", "Содержание раздела");
                    content_textarea.setAttribute("class", "form-control");
                    content_textarea.setAttribute("name", "content");
                    content_textarea.setAttribute("id", "content");
                    content.appendChild(content_textarea);
                    theme.appendChild(content);
                    output_div.appendChild(theme);
                }
            }
            document.getElementById("theme").addEventListener("input", function () {
                let vis = document.getElementsByClassName('vis')
                let target = document.getElementById(this.value);
                // console.log("vis", vis, "target", target);
                if (vis !== null) {
                    for (const visElement of vis) {
                        visElement.className = visElement.className.replace("vis", "d-none");
                        // console.log(visElement.className);
                    }
                }
                if (target !== null && target.value !== "choose_theme") {
                    target.className = target.className.replace("d-none", "vis");
                }
                if (target.value === "choose_theme") {
                    for (const visElement of vis) {
                        visElement.className = visElement.className.replace("vis", "d-none");
                        // console.log(visElement.className);
                    }
                }
                $('#smartwizard').smartWizard("fixHeight");
            });
        }
    });

    function addInputs() {
        document.getElementById("addInputGroup").remove();
        let new_div = document.createElement("div");
        document.getElementById("sections").appendChild(new_div);
        new_div.setAttribute("class", "mb-3");
        let new_div_group = document.createElement("div");
        new_div.appendChild(new_div_group);
        new_div_group.setAttribute("class", "input-group sections");
        let section_input = document.createElement("input");
        new_div_group.appendChild(section_input);
        section_input.setAttribute("class", "form-control section");
        section_input.setAttribute("type", "text");
        section_input.setAttribute("name", "section");
        let hours_input = document.createElement("input");
        new_div_group.appendChild(hours_input);
        hours_input.setAttribute("class", "form-control hour");
        hours_input.setAttribute("type", "number");
        hours_input.setAttribute("name", "hours");
        let new_button = document.createElement("button");
        document.getElementById("sections").appendChild(new_button);
        new_button.setAttribute("class", "btn btn-primary");
        new_button.setAttribute("type", "button");
        new_button.setAttribute("id", "addInputGroup");
        new_button.setAttribute("onclick", "addInputs()");
        new_button.textContent = "Добавить раздел";
        $('#smartwizard').smartWizard("fixHeight");
    }

    function addInputsMarks() {
        document.getElementById("addInputGroupMarks").remove();
        let new_div = document.createElement("div");
        document.getElementById("marks").appendChild(new_div);
        new_div.setAttribute("class", "mb-3");
        let new_div_group = document.createElement("div");
        new_div.appendChild(new_div_group);
        new_div_group.setAttribute("class", "input-group marks");
        let section_input = document.createElement("input");
        new_div_group.appendChild(section_input);
        section_input.setAttribute("class", "form-control mark");
        section_input.setAttribute("type", "text");
        section_input.setAttribute("name", "mark");
        let hours_input = document.createElement("input");
        new_div_group.appendChild(hours_input);
        hours_input.setAttribute("class", "form-control description");
        hours_input.setAttribute("type", "text");
        hours_input.setAttribute("name", "description");
        let new_button = document.createElement("button");
        document.getElementById("marks").appendChild(new_button);
        new_button.setAttribute("class", "btn btn-primary");
        new_button.setAttribute("type", "button");
        new_button.setAttribute("id", "addInputGroupMarks");
        new_button.setAttribute("onclick", "addInputsMarks()");
        new_button.textContent = "Добавить оценку";
        $('#smartwizard').smartWizard("fixHeight");
    }

    function generate_output() {
        //generate input with all sections
        let sections = document.getElementsByClassName("section");
        let hours = document.getElementsByClassName("hour");
        let contents = document.getElementById("section");
        let sections_str = "";
        if (sections.length === hours.length && sections.length === contents.children.length) {
            for (let i = 0; i < sections.length; i++) {
                sections_str += sections[i].value + ":" + hours[i].value + ":" + contents.children[i].children[1].children[1].value + ";";
            }
            let all_sections = document.createElement("input");
            all_sections.value = sections_str;
            all_sections.setAttribute("type", "hidden");
            all_sections.setAttribute("name", "all_sections");
            document.getElementById("sections").appendChild(all_sections);
        } else {
            let error_input = document.createElement("input");
            error_input.value = "error:sections-hour-mismatch";
            error_input.setAttribute("type", "hidden");
            error_input.setAttribute("name", "all_sections");
            document.getElementById("sections").appendChild(error_input);
        }
        //generate input with all modules
        let modules = document.getElementById("dropzone");
        let modules_str = "";
        for (let module of modules.children) {
            modules_str += module.textContent + ";";
        }
        let all_module = document.createElement("input");
        all_module.value = modules_str;
        all_module.setAttribute("type", "hidden");
        all_module.setAttribute("name", "all_modules");
        document.getElementById("dropzone").appendChild(all_module);
        //generate input with all marks
        let marks = document.getElementsByClassName("marks");
        let description = document.getElementsByClassName("description");
        let marks_str = "";
        for (let i = 0; i < marks.length; i++) {
            marks_str += marks[i].children[0].value + ":" + description[i].value + ";";
        }
        let all_marks = document.createElement("input");
        all_marks.value = marks_str;
        all_marks.setAttribute("type", "hidden");
        all_marks.setAttribute("name", "all_marks");
        document.getElementById("marks").appendChild(all_marks);
    }

    window.onload = function () {
        let textareas = document.getElementsByTagName("textarea");
        for (const textarea of textareas) {
            textarea.addEventListener('mouseout', function () {
                $('#smartwizard').smartWizard("fixHeight");
            });
        }
        document.getElementById("score_system").addEventListener('change', function () {
            if (this.checked) {
                document.getElementById("brs").className = "mb-3";
            } else {
                document.getElementById("brs").className = "mb-3 d-none";
            }
            $('#smartwizard').smartWizard("fixHeight");
        })
    }
</script>
</body>